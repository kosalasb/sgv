name: Generate Solar Video

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Install FFmpeg
        run: sudo apt-get install ffmpeg

      # --- IMAGE 1: THE GRAPH ---
      - name: Download Graph Image
        run: |
          curl -v \
          -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
          -H "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8" \
          -H "Accept-Language: en-US,en;q=0.9" \
          -H "Referer: https://solar.kandiv.lk/" \
          -H "X-Solar-Key: ${{ secrets.SOLAR_KEY }}" \
          -L -o graph.png \
          "${{ secrets.SOLAR_URL }}"

      # --- IMAGE 2: THE SUMMARY ---
      - name: Download Summary Image
        # Same secure logic, but adds ?view=summary to the URL
        run: |
          curl -v \
          -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
          -H "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8" \
          -H "Accept-Language: en-US,en;q=0.9" \
          -H "Referer: https://solar.kandiv.lk/" \
          -H "X-Solar-Key: ${{ secrets.SOLAR_KEY }}" \
          -L -o summary.png \
          "${{ secrets.SOLAR_URL }}?view=summary"

      # --- IMAGE 3: THE FLOW ---
      - name: Download Flow Image
        # Same secure logic, but adds ?view=summary to the URL
        run: |
          curl -v \
          -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
          -H "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8" \
          -H "Accept-Language: en-US,en;q=0.9" \
          -H "Referer: https://solar.kandiv.lk/" \
          -H "X-Solar-Key: ${{ secrets.SOLAR_KEY }}" \
          -L -o flow.png \
          "${{ secrets.SOLAR_URL }}?view=flow"

      - name: Verify Downloads
        run: |
          echo "Checking file types..."
          # Check Graph
          if [[ $(file -b --mime-type graph.png) == "text/html" ]]; then
            echo "❌ ERROR: Graph download failed (Got HTML)."
            exit 1
          fi
          # Check Summary
          if [[ $(file -b --mime-type summary.png) == "text/html" ]]; then
            echo "❌ ERROR: Summary download failed (Got HTML)."
            exit 1
          fi
          # Check Flow
          if [[ $(file -b --mime-type flow.png) == "text/html" ]]; then
            echo "❌ ERROR: Summary download failed (Got HTML)."
            exit 1
          fi

      - name: Create Slideshow Video
        # FIX: Updated concat=n=3 to join all 3 image streams
        # Inputs: [0]=Graph, [1]=Summary, [2]=Flow
        run: |
          ffmpeg -loop 1 -t 10 -i graph.png -loop 1 -t 10 -i summary.png -loop 1 -t 10 -i flow.png \
          -f lavfi -i anullsrc=channel_layout=stereo:sample_rate=44100 \
          -filter_complex "[0:v]scale=1280:720:force_original_aspect_ratio=decrease,pad=1280:720:(ow-iw)/2:(oh-ih)/2,setsar=1[v0];[1:v]scale=1280:720:force_original_aspect_ratio=decrease,pad=1280:720:(ow-iw)/2:(oh-ih)/2,setsar=1[v1];[2:v]scale=1280:720:force_original_aspect_ratio=decrease,pad=1280:720:(ow-iw)/2:(oh-ih)/2,setsar=1[v2];[v0][v1][v2]concat=n=3:v=1:a=0[v]" \
          -map "[v]" -map 3:a \
          -c:v libx264 -profile:v main -level 3.1 -preset medium -pix_fmt yuv420p \
          -c:a aac -shortest \
          -movflags +faststart \
          -y solar_graph.mp4
          
      - name: Commit and Push Video
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add -f solar_graph.mp4
          git commit -m "Update solar video" || echo "No changes to commit"
          git push
